# -*- coding: utf-8 -*-
import os
import json
import time

class ModeSwitcher:
    def __init__(self, config_manager, engine):
        self.cfg = config_manager
        self.engine = engine
        
        # åŒ¹é… user_config.json çš„è·¯å¾„
        paths = self.cfg.get_user_config('paths', {})
        self.state_path = os.path.join(paths.get('data_dir', 'data'), "switcher_state.json")
        
        # åˆå§‹åŒ–çŠ¶æ€ï¼ˆä½¿ç”¨ TaskController æœŸå¾…çš„å­—æ®µå games_in_current_modeï¼‰
        self.state = self._load_state()
        
        # æˆ¿ä¸»å¼€å…³é€»è¾‘
        self.enabled = self.cfg.get_user_config('mode_control', {}).get('enabled', False)
        self.interval = 5 
        
        self.refresh_config()

    def _load_state(self):
        default = {"current_mode": "mode_item", "games_in_current_mode": 0, "all_tasks_finished": False}
        if os.path.exists(self.state_path):
            try:
                with open(self.state_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    for k, v in default.items():
                        if k not in data: data[k] = v
                    return data
            except: pass
        return default

    def _save_state(self):
        try:
            os.makedirs(os.path.dirname(self.state_path), exist_ok=True)
            with open(self.state_path, 'w', encoding='utf-8') as f:
                json.dump(self.state, f, indent=4)
        except: pass

    def refresh_config(self):
        """åŒæ­¥ target åˆ° interval"""
        tasks = self.cfg.get_user_config('mode_control', {}).get('tasks', [])
        curr_id = self.state.get('current_mode', 'mode_item')

        target = 5
        for t in tasks:
            if t['id'] == curr_id:
                target = t.get('target', 5)
                break

        if self.interval != target:
            self.interval = target
            print(f"   [Switcher] æ¨¡å¼ {curr_id} ç›®æ ‡å±€æ•°: {target}")

# module_switcher.py å¢åŠ æˆ–ä¿®æ”¹æ­¤æ–¹æ³•

    def sync_current_mode(self, detected_mode_id):
        """
        åŸºäºè§†è§‰è¯†åˆ«ç»“æœå¼ºåˆ¶åŒæ­¥çŠ¶æ€
        """
        if detected_mode_id == "unknown":
            print("âš ï¸ è§†è§‰è¯†åˆ«æ— æ³•ç¡®å®šå½“å‰æ¨¡å¼ï¼Œå°†ä¿æŒé»˜è®¤çŠ¶æ€")
            return

        if self.state['current_mode'] != detected_mode_id:
            print(f"ğŸ¯ [è§†è§‰åŒæ­¥] å‘ç°å®é™…æ¨¡å¼ä¸º {detected_mode_id}ï¼Œæ­£åœ¨æ›´æ–°å†…éƒ¨è®¡æ•°å™¨...")
            self.state['current_mode'] = detected_mode_id
            self.state['games_in_current_mode'] = 0 # æ—¢ç„¶æ¨¡å¼å˜äº†ï¼Œè®¡æ•°å™¨é‡ç½®
            self._save_state()
            self.refresh_config()


    def report_game_finished(self):
        """æ¸¸æˆå¼€å§‹/ç»“æŸæ—¶ä¸ŠæŠ¥"""
        if self.state.get('all_tasks_finished', False):
            return

        self.state['games_in_current_mode'] += 1

        # æŸ¥æ‰¾æ¨¡å¼åç§°
        curr_mode_id = self.state['current_mode']
        mode_name = curr_mode_id
        mode_configs = self.cfg.get_config("mode_configs", [])
        for m in mode_configs:
            if m.get('id') == curr_mode_id:
                mode_name = m.get('name', curr_mode_id)
                break

        print(f"ğŸ“Š [è®¡æ•°] {mode_name}: {self.state['games_in_current_mode']}/{self.interval} (mode_id={curr_mode_id})")
        self._save_state()

# module_switcher.py é‡Œçš„ perform_switch

    def perform_switch(self, host_hwnd, task_controller=None):
        """åˆ©ç”¨ GameEngine é€‚é…åçš„è‡ªåŠ¨åˆ‡æ¢"""
        # è·å–æ¨¡å¼é…ç½®
        mode_configs = self.cfg.get_config("mode_configs", [])
        all_ids = [m['id'] for m in mode_configs]
        curr_id = self.state.get('current_mode', all_ids[0])

        # å¯»æ‰¾ä¸‹ä¸€ä¸ªæ¨¡å¼
        next_idx = (all_ids.index(curr_id) + 1) % len(all_ids)
        target_mode = mode_configs[next_idx]

        # ç›´æ¥è¯»å– 1920 åæ ‡
        mgr_pos = self.cfg.get_config("coords.room_management", [1650, 540])
        click_pos = target_mode['click_coord']
        confirm_pos = self.cfg.get_config("coords.confirm", [1500, 920])

        print(f"ğŸ”„ æ¨¡å¼åˆ‡æ¢: {curr_id} -> {target_mode['id']}")

        # æ‰§è¡Œç‚¹å‡»é¡ºåº
        self.engine.click(host_hwnd, mgr_pos[0], mgr_pos[1])
        time.sleep(1.2)

        self.engine.click(host_hwnd, click_pos[0], click_pos[1])
        time.sleep(1.0)

        self.engine.click(host_hwnd, confirm_pos[0], confirm_pos[1])

        # æ›´æ–°çŠ¶æ€
        self.state['current_mode'] = target_mode['id']
        self.state['games_in_current_mode'] = 0
        self._save_state()
        self.refresh_config()

        # é‡æ–°æå–æˆ¿é—´ä¿¡æ¯å¹¶æ›´æ–° session
        if task_controller:
            print(f"   [Switcher] é‡æ–°æå–æˆ¿é—´ä¿¡æ¯...")
            room_id, detected_mode = task_controller.extract_room_info_logic(host_hwnd)
            if room_id:
                task_controller.save_room_session(room_id, host_hwnd, detected_mode)
                print(f"âœ… Session å·²æ›´æ–°: æˆ¿å·[{room_id}] æ¨¡å¼[{detected_mode}]")

        # æ¸…é™¤æ¨¡å¼åˆ‡æ¢çŠ¶æ€
        task_controller.mode_switching[host_hwnd] = False
        return True






