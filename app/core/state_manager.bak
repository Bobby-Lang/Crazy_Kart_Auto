# -*- coding: utf-8 -*-
"""
æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨
è´Ÿè´£ç®¡ç†æ¸¸æˆçŠ¶æ€ã€å¯¹å±€è®¡æ•°ã€æˆ¿é—´å·ã€æˆ¿ä¸»ç­‰
"""

import time
import threading
import os
import win32gui
import cv2

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


class GameStateManager:
    """æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨"""

    def __init__(self, config_manager, logger):
        """
        åˆå§‹åŒ–çŠ¶æ€ç®¡ç†å™¨

        Args:
            config_manager: é…ç½®ç®¡ç†å™¨
            logger: æ—¥å¿—è®°å½•å™¨
        """
        self.config_manager = config_manager
        self.logger = logger

        # æˆ¿ä¸»ç›¸å…³
        self.host_hwnd = None
        self.room_id = None
        self.current_mode = None

        # å¯¹å±€è®¡æ•°
        self.game_counters = {}  # {mode_id: current_count}
        self.target_counters = {}  # {mode_id: target_count}

        # çª—å£è¿›åº¦
        self.window_progress = {}  # {hwnd: {'mode': '', 'current_game': 0}}

        # çº¿ç¨‹é”
        self.lock = threading.Lock()

        # åˆå§‹åŒ–è®¡æ•°å™¨
        self._init_counters()

    def _init_counters(self):
        """åˆå§‹åŒ–è®¡æ•°å™¨"""
        modes = self.config_manager.get_config('mode_configs', [])

        for mode in modes:
            mode_id = mode.get('id', '')
            target_games = mode.get('target_games', 0)

            self.game_counters[mode_id] = 0
            self.target_counters[mode_id] = target_games

    def set_host_hwnd(self, hwnd: int):
        """
        è®¾ç½®æˆ¿ä¸»çª—å£å¥æŸ„

        Args:
            hwnd: æˆ¿ä¸»çª—å£å¥æŸ„
        """
        with self.lock:
            self.host_hwnd = hwnd
            self.logger.log(0, "INFO", f"è®¾ç½®æˆ¿ä¸»çª—å£: {hwnd}")

    def get_host_hwnd(self) -> int:
        """è·å–æˆ¿ä¸»çª—å£å¥æŸ„"""
        with self.lock:
            return self.host_hwnd

    def update_host_hwnd(self, hwnds: list, engine):
        """
        é‡æ–°è¯†åˆ«æˆ¿ä¸»çª—å£ï¼ˆæˆ¿ä¸»è½¬ç§»åï¼‰

        Args:
            hwnds: æ‰€æœ‰çª—å£å¥æŸ„åˆ—è¡¨
            engine: æ¸¸æˆå¼•æ“

        Returns:
            æ–°æˆ¿ä¸»çª—å£å¥æŸ„æˆ–None
        """
        host_img_path = self.config_manager.get_template_path(
            self.config_manager.get_config('host_feature_img', 'host_feature.png')
        )

        if not host_img_path:
            self.logger.log(0, "WARN", "æˆ¿ä¸»ç‰¹å¾å›¾ç‰‡ä¸å­˜åœ¨")
            return None

        with self.lock:
            for hwnd in hwnds:
                if not win32gui.IsWindow(hwnd):
                    continue

                # æ£€æŸ¥æ˜¯å¦æœ‰æˆ¿ä¸»ç‰¹å¾
                found, score, _ = engine.match_template(hwnd, host_img_path, threshold=0.8)

                if found:
                    old_host = self.host_hwnd
                    self.host_hwnd = hwnd
                    self.logger.log(0, "INFO", f"æˆ¿ä¸»è½¬ç§»: {old_host} â†’ {hwnd} (åŒ¹é…åº¦: {score:.2%})")
                    return hwnd

        return None

    def set_room_id(self, room_id: str):
        """
        è®¾ç½®æˆ¿é—´å·

        Args:
            room_id: æˆ¿é—´å·
        """
        with self.lock:
            self.room_id = room_id
            self.logger.log(0, "INFO", f"æ›´æ–°æˆ¿é—´å·: {room_id}")

    def get_room_id(self) -> str:
        """è·å–æˆ¿é—´å·"""
        with self.lock:
            return self.room_id

    def set_current_mode(self, mode_id: str):
        """
        è®¾ç½®å½“å‰æ¸¸æˆæ¨¡å¼

        Args:
            mode_id: æ¨¡å¼ID
        """
        with self.lock:
            self.current_mode = mode_id
            mode_name = self._get_mode_name(mode_id)
            self.logger.log(0, "INFO", f"è®¾ç½®å½“å‰æ¨¡å¼: {mode_name} ({mode_id})")

    def get_current_mode(self) -> str:
        """è·å–å½“å‰æ¸¸æˆæ¨¡å¼"""
        with self.lock:
            return self.current_mode

    def increment_game_count(self, mode_id: str = None):
        """
        å¯¹å±€è®¡æ•°+1

        Args:
            mode_id: æ¨¡å¼IDï¼Œé»˜è®¤ä½¿ç”¨å½“å‰æ¨¡å¼
        """
        with self.lock:
            mode_id = mode_id or self.current_mode

            if mode_id not in self.game_counters:
                self.game_counters[mode_id] = 0

            self.game_counters[mode_id] += 1

            current = self.game_counters[mode_id]
            target = self.target_counters.get(mode_id, 0)
            mode_name = self._get_mode_name(mode_id)

            self.logger.log(0, "INFO", f"ğŸ {mode_name} ç¬¬{current}å±€å®Œæˆ ({current}/{target})")

    def get_progress(self, mode_id: str = None) -> tuple:
        """
        è·å–è¿›åº¦

        Args:
            mode_id: æ¨¡å¼IDï¼Œé»˜è®¤ä½¿ç”¨å½“å‰æ¨¡å¼

        Returns:
            (å½“å‰å±€æ•°, ç›®æ ‡å±€æ•°)
        """
        with self.lock:
            mode_id = mode_id or self.current_mode
            current = self.game_counters.get(mode_id, 0)
            target = self.target_counters.get(mode_id, 0)
            return (current, target)

    def is_mode_completed(self, mode_id: str = None) -> bool:
        """
        æ£€æŸ¥æ¨¡å¼æ˜¯å¦å®Œæˆ

        Args:
            mode_id: æ¨¡å¼IDï¼Œé»˜è®¤ä½¿ç”¨å½“å‰æ¨¡å¼

        Returns:
            æ˜¯å¦å®Œæˆ
        """
        current, target = self.get_progress(mode_id)
        return current >= target

    def is_all_modes_completed(self) -> bool:
        """
        æ£€æŸ¥æ‰€æœ‰æ¨¡å¼æ˜¯å¦å®Œæˆ

        Returns:
            æ˜¯å¦å…¨éƒ¨å®Œæˆ
        """
        with self.lock:
            for mode_id, target in self.target_counters.items():
                current = self.game_counters.get(mode_id, 0)
                if current < target:
                    return False
            return True

    def save_window_progress(self, hwnd: int, mode: str, game_num: int):
        """
        ä¿å­˜çª—å£è¿›åº¦

        Args:
            hwnd: çª—å£å¥æŸ„
            mode: æ¨¡å¼
            game_num: å½“å‰æ¸¸æˆç¼–å·
        """
        with self.lock:
            self.window_progress[hwnd] = {
                'mode': mode,
                'current_game': game_num,
                'timestamp': time.time()
            }

    def get_window_progress(self, hwnd: int) -> dict:
        """
        è·å–çª—å£è¿›åº¦

        Args:
            hwnd: çª—å£å¥æŸ„

        Returns:
            è¿›åº¦å­—å…¸
        """
        with self.lock:
            progress = self.window_progress.get(hwnd, {})
            mode = progress.get('mode', self.current_mode)
            game_num = progress.get('current_game', 1)
            return {
                'mode': mode,
                'current_game': game_num
            }

    def reset_mode(self, mode_id: str):
        """
        é‡ç½®æ¨¡å¼è®¡æ•°

        Args:
            mode_id: æ¨¡å¼ID
        """
        with self.lock:
            self.game_counters[mode_id] = 0
            mode_name = self._get_mode_name(mode_id)
            self.logger.log(0, "INFO", f"é‡ç½®æ¨¡å¼è®¡æ•°: {mode_name}")

    def reset_all_modes(self):
        """é‡ç½®æ‰€æœ‰æ¨¡å¼è®¡æ•°"""
        with self.lock:
            for mode_id in self.game_counters:
                self.game_counters[mode_id] = 0
            self.logger.log(0, "INFO", "é‡ç½®æ‰€æœ‰æ¨¡å¼è®¡æ•°")

    def get_summary(self) -> dict:
        """
        è·å–çŠ¶æ€æ‘˜è¦

        Returns:
            çŠ¶æ€å­—å…¸
        """
        with self.lock:
            summary = {
                'host_hwnd': self.host_hwnd,
                'room_id': self.room_id,
                'current_mode': self.current_mode,
                'games': {},
                'total_completed': 0,
                'total_target': 0
            }

            for mode_id in self.game_counters:
                current = self.game_counters.get(mode_id, 0)
                target = self.target_counters.get(mode_id, 0)
                mode_name = self._get_mode_name(mode_id)

                summary['games'][mode_id] = {
                    'name': mode_name,
                    'current': current,
                    'target': target
                }

                summary['total_completed'] += current
                summary['total_target'] += target

            return summary

    def _get_mode_name(self, mode_id: str) -> str:
        """è·å–æ¨¡å¼åç§°"""
        modes = self.config_manager.get_config('mode_configs', [])
        for mode in modes:
            if mode.get('id') == mode_id:
                return mode.get('name', mode_id)
        return mode_id
